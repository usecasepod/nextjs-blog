{"pageProps":{"post":{"date":"2020-05-24","slug":"2020-05-24-mvu-composition","content":"<p>So a couple days have come and gone and I'm still riding high on my experience with the MVU pattern. I'm struggling some with the syntax of F#, but I'm getting it bit by bit and even learning to love some aspects of it. That being said, the sample app I went through last time did nothing but peak my interest. It felt really smooth and easy to reason about, but \"Counters\" always are, right? So the next logical question is, how do we make this work for a more complicated situation?</p>\n<p>I did some digging, but all the examples I could find simply stuffed more code into the view. Which is fine for smaller tasks, but thats just not sustainable for an app with multiple pages and navigation. So I started googling but ended up going in all the wrong directions. Eventually, I came across something in the docs for Elmish (an F# MVU-like framework) that really opened things up. In the example, there's a <code>Counter</code> module that is used by a <code>CounterList</code> module which reuses the <code>Counter</code>'s model, update, and view logic. I could post the example and we could go through it, but I thought this might be a good chance to make some progress on <code>commutr_v2</code>.</p>\n<p>I'm going to start by trying to recreate the first page of the <code>commutr</code> app, which displays all the vehicles that you can track. Now in a future version of this app, we're going to skip this step if the user has marked a \"Primary\" vehicle. So really, this work is mostly going to be useless if it ever gets off the ground. But its a good simple case and a good first place to start. My first instinct is to follow the counter example I explained above. So we'll start with the smallest part first.</p>\n<h1>VehicleItem.fs</h1>\n<div class=\"remark-highlight\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">namespace</span> commutr_v2\n\n<span class=\"token keyword\">open</span> Fabulous\n<span class=\"token keyword\">open</span> Fabulous<span class=\"token punctuation\">.</span>XamarinForms\n<span class=\"token keyword\">open</span> Xamarin<span class=\"token punctuation\">.</span>Forms\n\n<span class=\"token keyword\">module</span> VehicleItem <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">type</span> <span class=\"token class-name\">Model</span> <span class=\"token operator\">=</span>\n      <span class=\"token punctuation\">{</span> Id <span class=\"token punctuation\">:</span> <span class=\"token class-name\">int</span>\n        Make <span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span>\n        Model <span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span>\n        Year <span class=\"token punctuation\">:</span> <span class=\"token class-name\">int</span>\n        IsPrimary <span class=\"token punctuation\">:</span> <span class=\"token class-name\">bool</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">type</span> <span class=\"token class-name\">Msg</span> <span class=\"token operator\">=</span>\n        <span class=\"token operator\">|</span> TogglePrimary <span class=\"token keyword\">of</span> <span class=\"token class-name\">bool</span>\n\n    <span class=\"token keyword\">let</span> init <span class=\"token punctuation\">(</span>initModel <span class=\"token punctuation\">:</span> <span class=\"token class-name\">Model</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> initModel\n\n    <span class=\"token keyword\">let</span> update msg model <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">match</span> msg <span class=\"token keyword\">with</span>\n        <span class=\"token operator\">|</span> TogglePrimary isPrimary <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span> model <span class=\"token keyword\">with</span> IsPrimary <span class=\"token operator\">=</span> isPrimary <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> view <span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Model</span><span class=\"token punctuation\">)</span> dispatch <span class=\"token operator\">=</span>\n        View<span class=\"token punctuation\">.</span><span class=\"token function\">StackLayout</span><span class=\"token punctuation\">(</span>padding <span class=\"token operator\">=</span> Thickness <span class=\"token number\">20.0</span><span class=\"token punctuation\">,</span> verticalOptions <span class=\"token operator\">=</span> LayoutOptions<span class=\"token punctuation\">.</span>Center<span class=\"token punctuation\">,</span> orientation <span class=\"token operator\">=</span> StackOrientation<span class=\"token punctuation\">.</span>Horizontal<span class=\"token punctuation\">,</span>\n            children <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n                View<span class=\"token punctuation\">.</span><span class=\"token function\">Label</span><span class=\"token punctuation\">(</span>text <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>Make<span class=\"token punctuation\">,</span> horizontalOptions <span class=\"token operator\">=</span> LayoutOptions<span class=\"token punctuation\">.</span>Center<span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">200.0</span><span class=\"token punctuation\">,</span> horizontalTextAlignment<span class=\"token operator\">=</span>TextAlignment<span class=\"token punctuation\">.</span>Center<span class=\"token punctuation\">)</span>\n                View<span class=\"token punctuation\">.</span><span class=\"token function\">Label</span><span class=\"token punctuation\">(</span>text <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">,</span> horizontalOptions <span class=\"token operator\">=</span> LayoutOptions<span class=\"token punctuation\">.</span>Center<span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">200.0</span><span class=\"token punctuation\">,</span> horizontalTextAlignment<span class=\"token operator\">=</span>TextAlignment<span class=\"token punctuation\">.</span>Center<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>This is pretty straight forward, so I won't go in too much detail. The plan here is to output a view that can be used as a child of a <code>CollectionView</code>. So we have our model which represents a vehicle, the update which can set whether the vehicle in question is \"Primary\", and the view which puts it all together. We may come back to this later, as I'm not entirely sure what actions will need to be handled here and what actions will need to be handled in parent components, but this seems like it handles everything I need for the moment.</p>\n<p>Now that we have the smallest piece set up, lets move one step higher.</p>\n<h1>VehicleListing.fs</h1>\n<div class=\"remark-highlight\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">module</span> VehicleListing <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">type</span> <span class=\"token class-name\">Model</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        Vehicles <span class=\"token punctuation\">:</span> <span class=\"token class-name\">VehicleItem<span class=\"token punctuation\">.</span>Model</span> list\n        SelectedVehicle <span class=\"token punctuation\">:</span> <span class=\"token class-name\">Option</span><span class=\"token operator\">&#x3C;</span>VehicleItem<span class=\"token punctuation\">.</span>Model<span class=\"token operator\">></span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">type</span> <span class=\"token class-name\">Msg</span> <span class=\"token operator\">=</span>\n        <span class=\"token operator\">|</span> Insert\n        <span class=\"token operator\">|</span> Remove\n        <span class=\"token operator\">|</span> Modified <span class=\"token keyword\">of</span> <span class=\"token class-name\">int <span class=\"token operator\">*</span> VehicleItem<span class=\"token punctuation\">.</span>Msg</span>\n        <span class=\"token operator\">|</span> SelectVehicle <span class=\"token keyword\">of</span> <span class=\"token class-name\">int</span>\n\n    <span class=\"token keyword\">let</span> initModel <span class=\"token punctuation\">:</span> <span class=\"token class-name\">Model</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> Vehicles <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n                            <span class=\"token punctuation\">{</span>Id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> Make <span class=\"token operator\">=</span> <span class=\"token string\">\"Honda\"</span><span class=\"token punctuation\">;</span> Model <span class=\"token operator\">=</span> <span class=\"token string\">\"Accord\"</span><span class=\"token punctuation\">;</span> Year <span class=\"token operator\">=</span> <span class=\"token number\">2005</span><span class=\"token punctuation\">;</span> IsPrimary <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">}</span>\n                            <span class=\"token punctuation\">{</span>Id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> Make <span class=\"token operator\">=</span> <span class=\"token string\">\"Honda\"</span><span class=\"token punctuation\">;</span> Model <span class=\"token operator\">=</span> <span class=\"token string\">\"Insight\"</span><span class=\"token punctuation\">;</span> Year <span class=\"token operator\">=</span> <span class=\"token number\">2019</span><span class=\"token punctuation\">;</span> IsPrimary <span class=\"token operator\">=</span> <span class=\"token keyword\">true</span><span class=\"token punctuation\">}</span>\n                            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                            SelectedVehicle <span class=\"token operator\">=</span> None <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> initModel\n\n    <span class=\"token keyword\">let</span> update msg model <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">match</span> msg <span class=\"token keyword\">with</span>\n        <span class=\"token operator\">|</span> Insert <span class=\"token operator\">-></span> model <span class=\"token comment\">//TODO: Make this do something</span>\n        <span class=\"token operator\">|</span> Remove <span class=\"token operator\">-></span> model <span class=\"token comment\">//TODO: Make this do something</span>\n        <span class=\"token operator\">|</span> Modified <span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">,</span> itemMessage<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span> model <span class=\"token keyword\">with</span> Vehicles <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>Vehicles\n                                                        <span class=\"token operator\">|></span> List<span class=\"token punctuation\">.</span>mapi <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> i itemModel <span class=\"token operator\">-></span>\n                                                        <span class=\"token keyword\">if</span> i <span class=\"token operator\">=</span> pos <span class=\"token keyword\">then</span>\n                                                            VehicleItem<span class=\"token punctuation\">.</span>update itemMessage itemModel\n                                                        <span class=\"token keyword\">else</span>\n                                                            itemModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">|</span> SelectVehicle pos <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>model <span class=\"token keyword\">with</span> SelectedVehicle <span class=\"token operator\">=</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>Vehicles<span class=\"token punctuation\">.</span><span class=\"token function\">Item</span><span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> view <span class=\"token punctuation\">(</span>model <span class=\"token punctuation\">:</span> <span class=\"token class-name\">Model</span><span class=\"token punctuation\">)</span> dispatch <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">let</span> items <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>Vehicles <span class=\"token operator\">|></span> List<span class=\"token punctuation\">.</span><span class=\"token function\">mapi</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> pos itemModel <span class=\"token operator\">-></span>\n                             VehicleItem<span class=\"token punctuation\">.</span>view\n                                itemModel\n                                <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> msg <span class=\"token operator\">-></span> dispatch <span class=\"token punctuation\">(</span>Modified <span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        View<span class=\"token punctuation\">.</span><span class=\"token function\">CollectionView</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>Now this is clearly a work in progress, but I wanted to map out where I'm heading while simultaneously getting the most simple case working first. There are three novel things that are happening here. The first is that part of the Model for this module is a list of models from the <code>VehicleItem</code> module. Model, module, model, module... bleh.</p>\n<p>Anyway, the second is in <code>update</code>. You'll notice the arguments for the <code>Modified</code> case are <code>pos</code> (an integer representing the position of the requested item in the array - aka its index) and <code>itemMessage</code> which is of type <code>VehicleItem.Msg</code>. Those arguments are then used to update the model that matches the correct position using <code>VehicleItem.update</code>. So all we're doing is routing the message back to the appropriate update function so that the result is a list of updated <code>VehicleItem.Model</code>s. And since our <code>update</code> functions are pure, we don't need a specific instance of anything, just pass the model and the message and the result will be the updated model.</p>\n<p>The last novel thing is in (you guessed it) the view. We get a list of items by mapping the List of <code>VehicleItem.Model</code> in our model to a list of Stack Layout Views via the <code>VehicleItem.view</code> function. There's something really interesting that we're doing here that makes this work. We're hijacking the <code>dispatch</code> function so that the <code>Modified</code> message gets sent instead. Its then up to our <code>Modified</code> message to update the appropriate item (using <code>VehicleItem.update</code> as we previously saw).</p>\n<p>Hopefully that makes sense.</p>\n<p>Now, you may notice that I defined a <code>SelectVehicle</code> message that will handle selection (and potentially navigation). I did this mostly just to work out how that might hypothetically look. It isn't used here because I realized that <code>CollectionView</code> requires you to wrap each item in a <code>SwipeView</code>, so we may have to move that logic down somehow. Or maybe not. I haven't gotten that far yet.</p>\n<p>Back to making the simplest case work.</p>\n<h1>Wiring It All Up</h1>\n<p>So now that we have the Vehicle List worked out, lets tie it all together in the root <code>App</code> module.</p>\n<div class=\"remark-highlight\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">namespace</span> commutr_v2\n\n<span class=\"token keyword\">open</span> System<span class=\"token punctuation\">.</span>Diagnostics\n<span class=\"token keyword\">open</span> Fabulous\n<span class=\"token keyword\">open</span> Fabulous<span class=\"token punctuation\">.</span>XamarinForms\n<span class=\"token keyword\">open</span> Fabulous<span class=\"token punctuation\">.</span>XamarinForms<span class=\"token punctuation\">.</span>LiveUpdate\n<span class=\"token keyword\">open</span> Xamarin<span class=\"token punctuation\">.</span>Forms\n\n<span class=\"token keyword\">module</span> App <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">type</span> <span class=\"token class-name\">Model</span> <span class=\"token operator\">=</span>\n      <span class=\"token punctuation\">{</span> Vehicles <span class=\"token punctuation\">:</span> <span class=\"token class-name\">VehicleListing<span class=\"token punctuation\">.</span>Model</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">type</span> <span class=\"token class-name\">Msg</span> <span class=\"token operator\">=</span>\n        <span class=\"token operator\">|</span> VehicleListUpdated <span class=\"token keyword\">of</span> <span class=\"token class-name\">VehicleListing<span class=\"token punctuation\">.</span>Msg</span>\n        <span class=\"token operator\">|</span> RefreshVehicles\n\n    <span class=\"token keyword\">let</span> initModel <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> Vehicles <span class=\"token operator\">=</span> VehicleListing<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> init <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> initModel<span class=\"token punctuation\">,</span> Cmd<span class=\"token punctuation\">.</span>none\n\n    <span class=\"token keyword\">let</span> update msg model <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">match</span> msg <span class=\"token keyword\">with</span>\n        <span class=\"token operator\">|</span> VehicleListUpdated listMsg <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>model <span class=\"token keyword\">with</span> Vehicles <span class=\"token operator\">=</span> VehicleListing<span class=\"token punctuation\">.</span>update listMsg model<span class=\"token punctuation\">.</span>Vehicles<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> Cmd<span class=\"token punctuation\">.</span>none\n        <span class=\"token operator\">|</span> RefreshVehicles <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>model <span class=\"token keyword\">with</span> Vehicles <span class=\"token operator\">=</span> VehicleListing<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> Cmd<span class=\"token punctuation\">.</span>none\n\n    <span class=\"token keyword\">let</span> view <span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Model</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>dispatch <span class=\"token punctuation\">:</span> <span class=\"token class-name\">Dispatch</span><span class=\"token operator\">&#x3C;</span>Msg<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">let</span> vehicleList <span class=\"token operator\">=</span> VehicleListing<span class=\"token punctuation\">.</span>view\n                            model<span class=\"token punctuation\">.</span>Vehicles\n                            <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> msg <span class=\"token operator\">-></span> dispatch <span class=\"token punctuation\">(</span>VehicleListUpdated msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        View<span class=\"token punctuation\">.</span><span class=\"token function\">ContentPage</span><span class=\"token punctuation\">(</span>\n          content <span class=\"token operator\">=</span> View<span class=\"token punctuation\">.</span><span class=\"token function\">StackLayout</span><span class=\"token punctuation\">(</span>padding <span class=\"token operator\">=</span> Thickness <span class=\"token number\">20.0</span><span class=\"token punctuation\">,</span> verticalOptions <span class=\"token operator\">=</span> LayoutOptions<span class=\"token punctuation\">.</span>Center<span class=\"token punctuation\">,</span>\n            children <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n                vehicleList\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Note, this declaration is needed if you enable LiveUpdate</span>\n    <span class=\"token keyword\">let</span> program <span class=\"token operator\">=</span> XamarinFormsProgram<span class=\"token punctuation\">.</span>mkProgram init update view\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> app <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">inherit</span> <span class=\"token class-name\">Application</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">let</span> runner <span class=\"token operator\">=</span>\n        App<span class=\"token punctuation\">.</span>program\n<span class=\"token preprocessor property\">#<span class=\"token directive keyword\">if</span> DEBUG</span>\n        <span class=\"token operator\">|></span> Program<span class=\"token punctuation\">.</span>withConsoleTrace\n<span class=\"token preprocessor property\">#<span class=\"token directive keyword\">endif</span></span>\n        <span class=\"token operator\">|></span> XamarinFormsProgram<span class=\"token punctuation\">.</span>run app\n</code></pre></div>\n<p>So this is not all that unsimilar to the <code>VehicleListing</code>. We make the child model part of our model and use the child's update and view logic in our own. The result isn't the prettiest, but it displays, so... a job well done?</p>\n<p><img src=\"/assets/posts/mvu-composition/wired-up-ui.png\" alt=\"Wired Up UI\"></p>\n<p>Clearly there are some changes that need to be made. For instance, not all the vehicle data is displayed and (to be quite frank) this UI is trash. So lets see if we can't make this thing just a little bit more appealing. The good news is this will likely involve mostly just tweaking the view code a little bit. So lets see what we can do...</p>\n<p>We'll change the <code>view</code> function of the <code>VehicleListing</code> to be the following:</p>\n<div class=\"remark-highlight\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> view <span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Model</span><span class=\"token punctuation\">)</span> dispatch <span class=\"token operator\">=</span>\n        View<span class=\"token punctuation\">.</span>StackLayout\n            <span class=\"token punctuation\">(</span>padding <span class=\"token operator\">=</span> Thickness <span class=\"token number\">5.0</span><span class=\"token punctuation\">,</span>\n             children <span class=\"token operator\">=</span>\n                 <span class=\"token punctuation\">[</span> View<span class=\"token punctuation\">.</span>Frame\n                     <span class=\"token punctuation\">(</span>hasShadow <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span>\n                      backgroundColor <span class=\"token operator\">=</span> AppColors<span class=\"token punctuation\">.</span>ghostWhite<span class=\"token punctuation\">,</span>\n                      padding <span class=\"token operator\">=</span> Thickness <span class=\"token number\">10.0</span><span class=\"token punctuation\">,</span>\n                      content <span class=\"token operator\">=</span>\n                          View<span class=\"token punctuation\">.</span>FlexLayout\n                              <span class=\"token punctuation\">(</span>margin <span class=\"token operator\">=</span> Thickness <span class=\"token number\">10.0</span><span class=\"token punctuation\">,</span>\n                               verticalOptions <span class=\"token operator\">=</span> LayoutOptions<span class=\"token punctuation\">.</span>Center<span class=\"token punctuation\">,</span>\n                               horizontalOptions <span class=\"token operator\">=</span> LayoutOptions<span class=\"token punctuation\">.</span>Center<span class=\"token punctuation\">,</span>\n                               alignItems <span class=\"token operator\">=</span> FlexAlignItems<span class=\"token punctuation\">.</span>Center<span class=\"token punctuation\">,</span>\n                               justifyContent <span class=\"token operator\">=</span> FlexJustify<span class=\"token punctuation\">.</span>SpaceEvenly<span class=\"token punctuation\">,</span>\n                               direction <span class=\"token operator\">=</span> FlexDirection<span class=\"token punctuation\">.</span>Row<span class=\"token punctuation\">,</span>\n                               children <span class=\"token operator\">=</span>\n                                   <span class=\"token punctuation\">[</span> View<span class=\"token punctuation\">.</span>SKCanvasView\n                                       <span class=\"token punctuation\">(</span>paintSurface <span class=\"token operator\">=</span>\n                                           <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> args <span class=\"token operator\">-></span>\n                                               <span class=\"token keyword\">let</span> info <span class=\"token operator\">=</span> args<span class=\"token punctuation\">.</span>Info\n                                               <span class=\"token keyword\">let</span> surface <span class=\"token operator\">=</span> args<span class=\"token punctuation\">.</span>Surface\n                                               <span class=\"token keyword\">let</span> canvas <span class=\"token operator\">=</span> surface<span class=\"token punctuation\">.</span>Canvas\n\n                                               canvas<span class=\"token punctuation\">.</span><span class=\"token function\">Clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n                                               <span class=\"token keyword\">use</span> paint <span class=\"token operator\">=</span>\n                                                   <span class=\"token keyword\">new</span> <span class=\"token class-name\">SkiaSharp<span class=\"token punctuation\">.</span>SKPaint</span><span class=\"token punctuation\">(</span>Style <span class=\"token operator\">=</span> SkiaSharp<span class=\"token punctuation\">.</span>SKPaintStyle<span class=\"token punctuation\">.</span>Fill<span class=\"token punctuation\">,</span>\n                                                                         Color <span class=\"token operator\">=</span>\n                                                                             <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> model<span class=\"token punctuation\">.</span>IsPrimary <span class=\"token keyword\">then</span>\n                                                                                 AppColors<span class=\"token punctuation\">.</span>mandarin<span class=\"token punctuation\">.</span><span class=\"token function\">ToSKColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                                                                              <span class=\"token keyword\">else</span>\n                                                                                  AppColors<span class=\"token punctuation\">.</span>silverSandLight<span class=\"token punctuation\">.</span><span class=\"token function\">ToSKColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                                                         StrokeWidth <span class=\"token operator\">=</span> <span class=\"token number\">5.0f</span><span class=\"token punctuation\">)</span>\n\n                                               canvas<span class=\"token punctuation\">.</span>DrawCircle\n                                                   <span class=\"token punctuation\">(</span>float32 <span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>Width <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> float32 <span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>Height <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10.0f</span><span class=\"token punctuation\">,</span> paint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                     View<span class=\"token punctuation\">.</span><span class=\"token function\">Label</span><span class=\"token punctuation\">(</span>text <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>Year<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                     View<span class=\"token punctuation\">.</span><span class=\"token function\">Label</span><span class=\"token punctuation\">(</span>text <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>Make<span class=\"token punctuation\">)</span>\n                                     View<span class=\"token punctuation\">.</span><span class=\"token function\">Label</span><span class=\"token punctuation\">(</span>text <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>Now thats quite a big difference, so lets break it down real quick.</p>\n<p>The basic layout is a <code>StackLayout</code> with a single <code>Frame</code> as the child. This is done so that we can create space between list elements via padding. The <code>Frame</code>'s content is a <code>FlexLayout</code> which allows us to evenly space the elements horizontally. Finally, we have a dot drawn via SkiaSharp that indicates the which is the primary, along with the reast of the info for the vehicle.</p>\n<p>The result looks like this:</p>\n<p><img src=\"/assets/posts/mvu-composition/spiffy-vehicle-list.png\" alt=\"Spiffy Vehicle List\"></p>\n<p>I decided to conditionally change the color of the primary indicator instead of hiding it so that things will continue to line up. The alignment and layout isn't perfect, but it feels pretty good so I'm going to leave it alone for now and move on to something more interesting. Lets try to wire up a <code>SwipeView</code> so that we can swipe on individual items and mark them as primary.</p>\n<h1>Toggle Primary</h1>\n<p>So before we get into the code that changed, I want to say that this was really quite painless to set up. In fact, most of the changes I've made were more improvments than they were \"making it work\". This is largely due to the nature of MVU. Since I spent a little bit of time mapping out what updates I wanted, the logic required to update the model was already there, it just took a little bit of work to finish putting it together. That being said lets dive in.</p>\n<div class=\"remark-highlight\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> update msg model <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">match</span> msg <span class=\"token keyword\">with</span>\n        <span class=\"token operator\">|</span> Insert <span class=\"token operator\">-></span> model <span class=\"token comment\">//TODO: Make this do something</span>\n        <span class=\"token operator\">|</span> Remove <span class=\"token operator\">-></span> model <span class=\"token comment\">//TODO: Make this do something</span>\n        <span class=\"token operator\">|</span> Modified <span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">,</span> itemMessage<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span>\n            <span class=\"token keyword\">match</span> itemMessage <span class=\"token keyword\">with</span>\n            <span class=\"token operator\">|</span> VehicleItem<span class=\"token punctuation\">.</span>Msg<span class=\"token punctuation\">.</span>TogglePrimary isPrimary <span class=\"token operator\">-></span>\n                <span class=\"token punctuation\">{</span> model <span class=\"token keyword\">with</span>\n                      Vehicles <span class=\"token operator\">=</span>\n                          model<span class=\"token punctuation\">.</span>Vehicles\n                          <span class=\"token operator\">|></span> List<span class=\"token punctuation\">.</span>mapi <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> i itemModel <span class=\"token operator\">-></span>\n                              <span class=\"token keyword\">if</span> i <span class=\"token operator\">=</span> pos <span class=\"token keyword\">then</span>\n                                  VehicleItem<span class=\"token punctuation\">.</span>update itemMessage itemModel\n                              <span class=\"token keyword\">else</span>\n                                  <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> isPrimary <span class=\"token operator\">&#x26;&#x26;</span> itemModel<span class=\"token punctuation\">.</span>IsPrimary\n                                   <span class=\"token keyword\">then</span> VehicleItem<span class=\"token punctuation\">.</span>update <span class=\"token punctuation\">(</span>VehicleItem<span class=\"token punctuation\">.</span><span class=\"token function\">TogglePrimary</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> itemModel\n                                   <span class=\"token keyword\">else</span> itemModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">|</span> SelectVehicle pos <span class=\"token operator\">-></span>\n            <span class=\"token punctuation\">{</span> model <span class=\"token keyword\">with</span>\n                  SelectedVehicle <span class=\"token operator\">=</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>Vehicles<span class=\"token punctuation\">.</span><span class=\"token function\">Item</span><span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> view <span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Model</span><span class=\"token punctuation\">)</span> dispatch <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">let</span> items <span class=\"token operator\">=</span>\n            model<span class=\"token punctuation\">.</span>Vehicles\n            <span class=\"token operator\">|></span> List<span class=\"token punctuation\">.</span>mapi <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> pos itemModel <span class=\"token operator\">-></span>\n                View<span class=\"token punctuation\">.</span>SwipeView\n                    <span class=\"token punctuation\">(</span>backgroundColor <span class=\"token operator\">=</span> AppColors<span class=\"token punctuation\">.</span>silverSandLight<span class=\"token punctuation\">,</span>\n                     rightItems <span class=\"token operator\">=</span>\n                         View<span class=\"token punctuation\">.</span>SwipeItems\n                             <span class=\"token punctuation\">(</span>items <span class=\"token operator\">=</span>\n                                 <span class=\"token punctuation\">[</span> View<span class=\"token punctuation\">.</span>SwipeItem\n                                     <span class=\"token punctuation\">(</span>text <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> itemModel<span class=\"token punctuation\">.</span>IsPrimary <span class=\"token keyword\">then</span> <span class=\"token string\">\"Primary\"</span> <span class=\"token keyword\">else</span> <span class=\"token string\">\"Not Primary\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                      backgroundColor <span class=\"token operator\">=</span>\n                                          <span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> itemModel<span class=\"token punctuation\">.</span>IsPrimary <span class=\"token keyword\">then</span>\n                                              AppColors<span class=\"token punctuation\">.</span>mandarin\n                                           <span class=\"token keyword\">else</span>\n                                               AppColors<span class=\"token punctuation\">.</span>silverSandMediumDark<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                      command <span class=\"token operator\">=</span>\n                                          <span class=\"token keyword\">fun</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span>\n                                              dispatch\n                                                  <span class=\"token punctuation\">(</span><span class=\"token function\">Modified</span><span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">,</span> VehicleItem<span class=\"token punctuation\">.</span><span class=\"token function\">TogglePrimary</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">not</span> itemModel<span class=\"token punctuation\">.</span>IsPrimary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                     content <span class=\"token operator\">=</span> VehicleItem<span class=\"token punctuation\">.</span>view itemModel <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> msg <span class=\"token operator\">-></span> dispatch <span class=\"token punctuation\">(</span><span class=\"token function\">Modified</span><span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        View<span class=\"token punctuation\">.</span><span class=\"token function\">CollectionView</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>Let's start by looking at the <code>view</code> function. Instead of mapping our <code>VehicleItem.Model</code>'s directly to their <code>view</code> function, we wrap them in a <code>SwipeView</code>. I think it would have also been feasible to implement the swipe view one step down in the body of <code>VehicleItem.view</code>, but it felt right to keep <code>VehicleItem</code> to strictly displaying the Vehicle information.</p>\n<p>You'll notice that the <code>SwipeView</code> contains a <code>SwipeItem</code> which has some conditional rendering of the text and background color. This is just so that we can distinguish between adding and removing the \"Primary\" status. I used the <code>SwipeItem</code>'s command property to fire dispatch and send the appropriate message. Really and truly, I realized that my <code>Modified</code> message handling is a bit more complicated than it needs to be right now. This is because I'm assuming that <code>VehicleItem</code> will eventually require additional messages (for things like updating the Make, Model) and that that logic will need to be <em>different</em> from the logic that handles IsPrimary.</p>\n<p>This is primarily for two different reasons. One is that only one vehicle can have \"Primary\" status at a time, so if \"Primary\" status changes for one vehicle, it <em>may</em> affect the others (this is reflected in the <code>update</code> function, but we'll get to that in a minute). This is simply not true of other properties like Make, Model, and Year.</p>\n<p>The second reason is actually not visible in the above code. There is a small change I made to <code>VehicleItem</code>, which basically amounts to forcing SkiaSharp to redraw the little circles on every update. This is fine for right now, because the only reason <code>VehicleItem.update</code> is called at the moment is to change <code>IsPrimary</code> which requires a redraw of the dot. However, as we add other messages, we will need to make sure we don't redraw on every update as this will result in performance hits.</p>\n<p>So this is where we are UI-wise:</p>\n<p><img src=\"/assets/posts/mvu-composition/mark-primary.gif\" alt=\"Mark Primary UI\"></p>\n<p>You'll notice that selecting one as Primary makes the other not primary (if it already was). This logic is handled in our <code>update</code> function. Our <code>Modified</code> message contains the position and the <code>VehicleItem.Msg</code> we want to pass on to <code>VehicleItem.update</code>. Now we could for the time being have made <code>Modified</code> to contain the <code>TogglePrimary</code> message instead of any <code>VehicleItem.Msg</code>, because for now that's the only message that <code>VehicleItem</code> has, but as I said earlier, this will allow us to handle future scenarios where we want to edit other information. So we pattern match on <code>itemMessage</code> and handle the only existing case (where <code>itemMessage</code> is the <code>TogglePrimary</code> message).</p>\n<p>We are also no longer simply calling <code>VehicleItem.update</code> on the item that matches the position we were given. We're also checking if we're setting a new item as Primary and mark any other items that are currently \"Primary\" to false. This will ensure that only one item is ever marked as Primary at a time.</p>\n<p>Before we wrap things up, I want to mention that I <em>think</em> this validates my assumption that we can handle \"Selecting\" a particular vehicle item within <code>VehicleListing</code>. We should be able to call dispatch to send a selection message from a <code>SwipeItem</code>.</p>\n<h1>Wrapping Up</h1>\n<p>So I think this is the state I'll leave the app in for the purposes of this article. I think it gives a pretty good idea of how composition in MVU can allow us to break out parts of the UI into smaller units. So I guess the question is, what did we learn from this?</p>\n<p>My first big take away is that this architecture is so straight forward that it was fairly easy for me to do a lot of planning ahead without really having a super great understanding of how all the pieces would fit together. For instance, I was pleasantly surprised by how decisions I made when creating <code>VehicleItem</code> panned out when connecting them to <code>VehicleListing</code>. The simplicity of this framework really does allow you to think clearly and accurately about what changes should and will occur to the model as well as what the resulting UI will look like.</p>\n<p>I will note that I did not do any Commanding, which I think will complicate matters when it is needed, but the beautify of this framework is that its not necessary so far, so I didn't have to use it.</p>\n<p>I'd also like to take this time to mention that I did have certain struggles with using additional libraries. One thing I've come to realize is that there isn't a lot of documentation for Fabulous and that examples of F# code in general are hard to find. This can make it difficult to learn, but also frustrating for someone who is used to being able to \"just read the docs\".</p>\n<p>Another thing I'd like to note is that quite frankly, 3rd party support for F# in Xamarin.Forms basically does not exist. I had wanted to use Sharpnado's MaterialFrame so I could get the Acrylic look, but quickly found out that MaterialFrame is built to be used strictly in XAML. This was a bit disappointing, but ultimately not a big deal. My hope is that with .NET MAUI, we'll start to see some of these UI tools become more \"Functional Friendly\" with built in support that goes beyond data binding and MVVM.</p>\n<p>I do plan to continue working on this project, but I think this will be my last blog on it for a while. I need to spend some more time digging in to F# and MVU so that I can really understand it and find some interesting ways to use it, before I can share any more insights.</p>\n<p>In the meantime, go give us some listens and feel free to reach out in the comments below, on Twitter <a href=\"twitter.com/usecasepod\">@usecasepod</a>, or <a href=\"mailto:usecasepod@gmail.com\">via email (usecasepod@gmail.com)</a>.</p>\n<p>You can also find the full repository for this app <a href=\"https://github.com/usecasepod/commutr_v2\">on our Github</a>, but keep in mind that this is going to be a living project, so what you see in this post today may not be reflected in the current version of the app.</p>\n","author":"Austin Webre","title":"Exploring MVU Part 2: Composition","categories":["Posts"]}},"__N_SSG":true}